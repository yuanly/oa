<html contenteditable=true>
	<head>
	<link rel="shortcut icon" href="../../../logo/zhongtailogo.ico">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta http-equiv="Cache-Control" content="max-age=0"> 
	<link type="text/css" rel="stylesheet" href="../../../css/my.css" />
	<link type="text/css" rel="stylesheet" href="../../../css/oa.css" />
	<link type="text/css" rel="stylesheet" href="../../../css/layout-default-latest.css" />
<link rel="stylesheet" href="../../../css/ui-lightness/jquery-ui-1.10.2.custom.min.css" type="text/css" media="screen">
	<title>装柜单打印（内部版）</title>
	<script src="../../../js/jquery-1.9.1.js" type="text/javascript"></script>
	<script src="../../../js/jquery-migrate-1.1.1.js" type="text/javascript"></script> 
	<script src="../../../xheditor-1.2.1/xheditor-1.2.1.min.js" type="text/javascript"></script>    
	<script src="../../../xheditor-1.2.1/xheditor_lang/zh-cn.js" type="text/javascript"></script>
	<script src="../../../js/my.js" type="text/javascript"></script>
	<script src="../../../js/localstorage.js" type="text/javascript"></script>
	<script src="../../../js/server.js" type="text/javascript"></script>
	<script src="../../../uploader/client/fileuploader.js" type="text/javascript"></script>
	<script src="../../../js/jquery-ui-1.10.2.custom.js" type="text/javascript"></script>
	<style> 
		.tr_gonghuoshanghuizong{
			border:1px solid black;
		}
		.tr_gonghuoshanghuizong span{
			font-size:1.0em;
			color:black;
		}
		.tr_huowumingxi td{
			border:1px dotted black;
			font-size:0.8em;
			padding-left:5px;
		}
		th{
			border:1px solid black;
		}
	</style>
	<script>
		$(function(){
			$("tr").dblclick(function(){
				var tr = $("<tr style='border:0px '><td colspan=8>&nbsp;</td></tr>");
				$(this).before(tr);
				tr.dblclick(function(){$(this).remove();});
			});
			function getDDID(id){
				return id.substr(0,id.toUpperCase().indexOf("HW"));
			}
			function shortHWID(id){//FHD140330.2HW2 to 0330.2-2
				return id.substring(5).replace("HW","-");
			}
			function shortDDID(id){//DD140328.2HW1 to 0328.2
				return id.substr(0,id.toUpperCase().indexOf("HW")).substring(4);
			}
			var tmpl_tr_gonghuoshanghuizong = $(".tr_gonghuoshanghuizong").detach();
			var tmpl_tr_huowumingxi = $(".tr_huowumingxi").detach();
   		postJson("zhuangguidan.php",{caozuo:"getbyid",_id:getUrl().showId},function(zgd){
   			$("#guihao").text(zgd.guihao);
   			$("#bianhao").text(zgd._id);
   			$("#zhuangguiriqi").text(zgd.zhuangguiriqi);
   			$("#zongjianshu").text(zongjianshu(zgd.huowu));
   			$("#zhuangguirenyuan").text(zgd.zhuangguirenyuan);
				dayin(zgd.huowu.sort(sortHuowu));
   		});
   		function zongjianshu(hws){
   			var zjs=0;
   			each(hws,function(i,hw){
   				zjs += parseInt(hw.jianshu);
   			});
   			return zjs;
   		}
			function dayin(huowus){
				kehuhuizong(huowus);
				var ghsHuowus = gonghuoshangGroup(huowus);
				ghsHuowus = ghsHuowus.sort(cmpQuyu);
				gonghuoshanghuizong(ghsHuowus);
				each(ghsHuowus,function(i,ghsHuowu){
					dayinGhsHuowu(ghsHuowu);
				});
			}
			function dayinGhsHuowu(hws){
				var ddHuowus = dingdanGroup(hws);
				each(ddHuowus,function(i,huowus){
					dayinDingdanHuowu(huowus);
				});
			}
			function dingdanGroup(huowus){
				var map = {};
				each(huowus,function(i,hw){
					if(undefined == map[getDDID(hw.dingdanhuowu)]){
						map[getDDID(hw.dingdanhuowu)] = [hw];
					}else{
						map[getDDID(hw.dingdanhuowu)].push(hw);
					}
				});
				var ret = [];
				for(k in map){
					ret.push(map[k]);
				}
				return ret;
			}
			function dayinDingdanHuowu(hws){
				//地区：xx 供货商：xxx  样板：xxx  订单：xx 总件数： nn
				var zongjianshu = 0;
				each(hws,function(i,hw){
					zongjianshu += parseInt(hw.jianshu);
				});
				var tr = tmpl_tr_gonghuoshanghuizong.clone(true);
				tr.find("#quyu").text(hws[0].gonghuoshang.quyu?hws[0].gonghuoshang.quyu:"-");
				tr.find("#gonghuoshang").text(hws[0].gonghuoshang.mingchen);
				tr.find("#yangban").html(formatYangban(hws[0].yangban));
				tr.find("#dingdan").text(getDDID(hws[0].dingdanhuowu));
				tr.find("#kehu").text(hws[0].kehu);
				tr.find("#zongjianshu").text(zongjianshu);
				$("#tb_zhuangguidan").append(tr);
				hws = hws.sort(cmpDingdan);
				each(hws,function(i,hw){
					var tr = tmpl_tr_huowumingxi.clone(true);
					tr.find("#td_bianhao").text(hw._id);
 					//tr.find("#td_bianhao").text(shortHWID(hw._id));
 					//tr.find("#td_dingdan").text(shortDDID(hw.dingdanhuowu));
 					//tr.find("#td_yangban").text(formatYangban(hws[0].yangban));
 					tr.find("#td_guige").text(hw.guige);
 					tr.find("#td_shuliang").text(hw.shuliang+hw.danwei);
 					tr.find("#td_jianshu").text(hw.jianshu);
 					//tr.find("#td_kehu").text(hw.kehu);
 					$("#tb_zhuangguidan").append(tr);
				});
			}
			function cmpDingdan(a,b){
				if(a.dingdanhuowu>b.dingdanhuowu){
					return 1;
				}else if(a.dingdanhuowu>b.dingdanhuowu){
					return -1;
				}
				return 0;
			}
			function sortHuowu(a,b){
				if(a.gonghuoshang.quyu>b.gonghuoshang.quyu){
					return 1;
				}else if(a.gonghuoshang.quyu<b.gonghuoshang.quyu){
					return -1;
				}else{
					if(a.gonghuoshang._id>b.gonghuoshang._id){
						return 1;
					}else if(a.gonghuoshang._id<b.gonghuoshang._id){
						return -1;
					}else{
						if(a.dingdanhuowu>b.dingdanhuowu){
							return 1;
						}else if(a.dingdanhuowu<b.dingdanhuowu){
							return -1;
						}else{
							if(a._id>b._id){
								return 1;
							}else if(a._id<b._id){
								return -1;
							}else{
								return 0;
							}
						}
					}
				}
			}
			function cmpQuyu(a,b){
				var q1 = a[0].gonghuoshang.quyu?a[0].gonghuoshang.quyu:"";
				var q2 = b[0].gonghuoshang.quyu?b[0].gonghuoshang.quyu:"";
				if(q1>q2){
					return 1;
				}
				if(q1<q2){
					return -1;
				}
				return 0;
			}
			function gonghuoshanghuizong(ghsHuowus){
				var str = "<hr style='border:1px dashed'/>";
				each(ghsHuowus,function(i,huowus){
					var zongjianshu = 0;
					each(huowus,function(i,hw){
						zongjianshu += parseInt(hw.jianshu);	
					});
					str += huowus[0].gonghuoshang.mingchen+"：<b>"+zongjianshu+"</b>件&nbsp;&nbsp;&nbsp;&nbsp;";
				});
				$("#td_kehuhuizong").append(str);
			}
			function gonghuoshangGroup(huowus){
				var map = {};
				each(huowus,function(i,hw){
					if(undefined == map[hw.gonghuoshang._id]){
						map[hw.gonghuoshang._id] = [hw];
					}else{
						map[hw.gonghuoshang._id].push(hw);
					}
				});
				var ret = [];
				for(k in map){
					ret.push(map[k]);
				}
				return ret;
			}
			function kehuhuizong(hws){
				var s = {};
				each(hws,function(i,hw){
					if(undefined == s[hw.kehu]){
						s[hw.kehu] = parseInt(hw.jianshu);
					}else {
						s[hw.kehu] += parseInt(hw.jianshu);
					}				
				});
				var huizong = "";
				for(k in s){
					huizong += "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"+k+":<b>"+s[k]+"</b>件";
				};
				$("#td_kehuhuizong").html(huizong);
			}
		});
	</script>
	</head>
<body style="margin:0px;padding:0px">
 <div align=center>
 	<div style="font-size:1.2em">第<span style="font-size:1.6em" id="guihao">50</span>柜装柜清单</div>
 	<div style="font-size:0.7em">编号：<div id="bianhao" class="myinput"></div>&nbsp;&nbsp;
 		装柜日期：<div id="zhuangguiriqi" class="myinput"></div>&nbsp;&nbsp;
 		总件数：<div id="zongjianshu" class="myinput" style="min-width:30px"></div>&nbsp;&nbsp;
 		装柜人员：<div id="zhuangguirenyuan" class="myinput"></div></div>
 </div>
 <table style="width:100%;border-spacing:0px;border-collapse:collapse;border:0px solid black;margin-top:10px;" border=0 id="tb_zhuangguidan">
 	<tr style="background-color:#eee">
 		<th>货物编号</th><th>规格</th><th>数量</th><th>件数</th><th style="width:25%" nowrap>备注</th>
 	</tr>
 	<tr>
 		<td style="border:1px solid black;paddig-left:5px;text-align:left;font-size:0.8em" id="td_kehuhuizong" colspan=8 ></td>
 	</tr>
 	<tr class="tr_gonghuoshanghuizong" style="border-top:2px solid black;">
 		<td colspan=8 style="color:gray;font-size:0.6em;padding-left:5px">
 			区域：<span id="quyu" style="font-size:1em;font-weight:bolder;"></span>，
 			商家：<span id="gonghuoshang" style="font-size:1em;font-weight:bolder;"></span>，
 			样板：<span id="yangban" style="font-size:1em;font-weight:bolder;"></span>，
 			订单：<span id="dingdan" style="font-size:1em;font-weight:bolder;"></span>，
 			客户：<span id="kehu" style="font-size:1em;font-weight:bolder;"></span>
 			<span style="float:right">总件数：<span id="zongjianshu" style="font-size:1.2em;font-weight:bolder;"></span>件&nbsp;&nbsp;</span>
 		</td>
 	</tr>
 	<tr class="tr_huowumingxi">
 		<td id="td_bianhao" style="width:70px;border-left:1px solid black">编号</td>
 		<td id="td_guige">规格</td>
 		<td id="td_shuliang" style="width:60px;text-align:center">数量</td>
 		<td id="td_jianshu" style="width:50px;text-align:center">件数</td>
 		<td style="width:25%;border-right:1px solid"></td>
 	</tr>
</table>
</body>
</html>